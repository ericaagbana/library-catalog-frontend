<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Digital Library</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin-specific styles */
        .admin-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #435f4a;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #435f4a;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .admin-actions {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn-admin {
            background: #435f4a;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .btn-admin:hover {
            background: #324a38;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .books-list {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .book-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .book-item:last-child {
            border-bottom: none;
        }
        
        .book-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }
        
        .book-meta {
            color: #666;
            font-size: 14px;
        }
        
        .book-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .edit-btn {
            background: #ffc107;
            color: #333;
        }
        
        .delete-btn {
            background: #dc3545;
            color: white;
        }
        
        .admin-only {
            display: none;
        }
        
        .user-role.admin .admin-only {
            display: block;
        }
    </style>
</head>
<body onload="checkAdminAccess()">
    <div class="container">
        <aside class="sidebar">
            <h2 class="logo">Admin Dashboard</h2>
            
            <div class="section">
                <h3>Navigation</h3>
                <a href="index.html" class="nav-link">‚Üê Back to Catalogue</a>
                <a href="#" onclick="showSection('dashboard')" class="nav-link">üìä Dashboard</a>
                <a href="#" onclick="showSection('addBook')" class="nav-link">üìö Add New Book</a>
                <a href="#" onclick="showSection('manageBooks')" class="nav-link">üìñ Manage Books</a>
                <a href="#" onclick="showSection('users')" class="nav-link">üë• Manage Users</a>
            </div>
            
            <div class="section">
                <h3>Quick Stats</h3>
                <div id="quickStats">
                    <p>Loading statistics...</p>
                </div>
            </div>
            
            <div class="section">
                <button class="btn-admin" onclick="logoutUser()" style="width: 100%;">Logout</button>
            </div>
        </aside>
        
        <main class="content">
            <div class="admin-header">
                <h2>Library Administration</h2>
                <div class="profile">
                    <img src="pfp.jpeg" alt="profile picture">
                    <span id="adminName">Loading...</span>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <div id="dashboardSection" class="admin-section">
                <h3>üìä Overview</h3>
                
                <div class="admin-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalBooks">0</div>
                        <div class="stat-label">Total Books</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="availableBooks">0</div>
                        <div class="stat-label">Available Books</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeBorrows">0</div>
                        <div class="stat-label">Active Borrows</div>
                    </div>
                </div>
                
                <div class="admin-actions">
                    <h4>Quick Actions</h4>
                    <button class="btn-admin" onclick="showSection('addBook')">‚ûï Add New Book</button>
                    <button class="btn-admin" onclick="loadAllBooks()">üîÑ Refresh Books List</button>
                    <button class="btn-admin" onclick="showSection('users')">üë• View All Users</button>
                </div>
            </div>
            
            <!-- Add Book Section -->
            <div id="addBookSection" class="admin-section" style="display: none;">
                <h3>üìö Add New Book</h3>
                
                <div class="admin-actions">
                    <form id="addBookForm" onsubmit="event.preventDefault(); addBook();">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="bookTitle">Title *</label>
                                <input type="text" id="bookTitle" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="bookAuthor">Author *</label>
                                <input type="text" id="bookAuthor" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="bookISBN">ISBN</label>
                                <input type="text" id="bookISBN">
                            </div>
                            
                            <div class="form-group">
                                <label for="bookCategory">Category</label>
                                <select id="bookCategory">
                                    <option value="Fiction">Fiction</option>
                                    <option value="Nonfiction">Nonfiction</option>
                                    <option value="Business">Business</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Science">Science</option>
                                    <option value="Biography">Biography</option>
                                    <option value="Mystery">Mystery</option>
                                    <option value="Self-help">Self-help</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="bookCopies">Number of Copies *</label>
                                <input type="number" id="bookCopies" value="1" min="1" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="bookYear">Publication Year</label>
                                <input type="number" id="bookYear" min="1900" max="2025">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="bookDescription">Description</label>
                            <textarea id="bookDescription" placeholder="Enter book description..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn-admin">Add Book to Library</button>
                        <button type="button" class="btn-admin" onclick="clearBookForm()" style="background: #6c757d;">Clear Form</button>
                    </form>
                </div>
            </div>
            
            <!-- Manage Books Section -->
            <div id="manageBooksSection" class="admin-section" style="display: none;">
                <h3>üìñ Manage Books</h3>
                
                <div class="books-list">
                    <div style="margin-bottom: 20px;">
                        <input type="text" id="searchBooks" placeholder="Search books..." style="width: 300px; padding: 10px;">
                        <button class="btn-admin" onclick="searchBooks()">Search</button>
                        <button class="btn-admin" onclick="loadAllBooks()" style="background: #6c757d;">Show All</button>
                    </div>
                    
                    <div id="booksList">
                        <p>Loading books...</p>
                    </div>
                </div>
            </div>
            
            <!-- Manage Users Section -->
            <div id="usersSection" class="admin-section" style="display: none;">
                <h3>üë• Manage Users</h3>
                
                <div class="admin-actions">
                    <div id="usersList">
                        <p>Loading users...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script src="script.js"></script>
    <script>
    // Admin-specific JavaScript
    let currentUser = null;
    let allBooks = [];
    
    // Check if user is admin
    function checkAdminAccess() {
        const user = JSON.parse(localStorage.getItem('user') || 'null');
        const token = localStorage.getItem('token');
        
        if (!user || !token || user.role !== 'admin') {
            alert('Admin access required. Redirecting to login...');
            window.location.href = 'login.html';
            return;
        }
        
        currentUser = user;
        document.getElementById('adminName').textContent = user.email + ' (Admin)';
        
        // Load dashboard data
        loadDashboardStats();
        loadAllBooks();
        loadAllUsers();
        
        // Show dashboard by default
        showSection('dashboard');
    }
    
    // Show/hide sections
    function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('.admin-section').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show selected section
        document.getElementById(sectionId + 'Section').style.display = 'block';
    }
    
    // Load dashboard statistics
    async function loadDashboardStats() {
        try {
            const books = await loadBooks();
            const users = await loadUsers();
            
            document.getElementById('totalBooks').textContent = books.length;
            
            const available = books.reduce((sum, book) => sum + book.available_copies, 0);
            document.getElementById('availableBooks').textContent = available;
            
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('activeBorrows').textContent = '0'; // Placeholder
            
            // Update quick stats in sidebar
            document.getElementById('quickStats').innerHTML = `
                <p>üìö Books: ${books.length}</p>
                <p>üë• Users: ${users.length}</p>
                <p>‚úÖ Available: ${available}</p>
            `;
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    }
    
    // Load all books for management
    async function loadAllBooks() {
        try {
            const books = await loadBooks();
            allBooks = books;
            displayBooksList(books);
        } catch (error) {
            console.error('Error loading books:', error);
            document.getElementById('booksList').innerHTML = '<p>Error loading books</p>';
        }
    }
    
    // Display books in management list
    function displayBooksList(books) {
        const container = document.getElementById('booksList');
        
        if (!books || books.length === 0) {
            container.innerHTML = '<p>No books found</p>';
            return;
        }
        
        let html = '';
        books.forEach(book => {
            html += `
                <div class="book-item">
                    <div class="book-info">
                        <h4>${book.title}</h4>
                        <div class="book-meta">
                            Author: ${book.author} | 
                            Category: ${book.category} | 
                            ISBN: ${book.isbn || 'N/A'} | 
                            Copies: ${book.available_copies}/${book.copies}
                        </div>
                        ${book.description ? `<p style="margin-top: 5px; font-size: 13px; color: #666;">${book.description.substring(0, 100)}...</p>` : ''}
                    </div>
                    <div class="book-actions">
                        <button class="action-btn edit-btn" onclick="editBook(${book.id})">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteBook(${book.id})">Delete</button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Search books
    function searchBooks() {
        const searchTerm = document.getElementById('searchBooks').value.toLowerCase();
        
        if (!searchTerm) {
            displayBooksList(allBooks);
            return;
        }
        
        const filtered = allBooks.filter(book => 
            book.title.toLowerCase().includes(searchTerm) ||
            book.author.toLowerCase().includes(searchTerm) ||
            (book.isbn && book.isbn.includes(searchTerm))
        );
        
        displayBooksList(filtered);
    }
    
    // Add new book
    async function addBook() {
        const bookData = {
            title: document.getElementById('bookTitle').value,
            author: document.getElementById('bookAuthor').value,
            isbn: document.getElementById('bookISBN').value || null,
            category: document.getElementById('bookCategory').value,
            copies: parseInt(document.getElementById('bookCopies').value),
            description: document.getElementById('bookDescription').value || '',
            available_copies: parseInt(document.getElementById('bookCopies').value)
        };
        
        if (!bookData.title || !bookData.author || !bookData.copies) {
            alert('Please fill in all required fields (Title, Author, Copies)');
            return;
        }
        
        try {
            const response = await apiCall('/api/books', 'POST', bookData);
            alert('Book added successfully!');
            clearBookForm();
            loadAllBooks();
            loadDashboardStats();
            showSection('manageBooks');
        } catch (error) {
            alert('Error adding book: ' + error.message);
        }
    }
    
    // Clear book form
    function clearBookForm() {
        document.getElementById('addBookForm').reset();
    }
    
    // Edit book (placeholder)
    // Edit book - load book data into form
    async function editBook(bookId) {
        try {
            // Fetch book details
            const book = await apiCall(`/api/books/${bookId}`);
            
            // Populate form fields
            document.getElementById("bookTitle").value = book.title;
            document.getElementById("bookAuthor").value = book.author;
            document.getElementById("bookISBN").value = book.isbn || "";
            document.getElementById("bookCategory").value = book.category || "General";
            book.copies = book.copies;
            document.getElementById("bookYear").value = book.year || "";
            document.getElementById("bookDescription").value = book.description || "";
            
            // Change form to update mode
            const form = document.getElementById("addBookForm");
            const submitBtn = form.querySelector("button[type="submit"]");
            const clearBtn = form.querySelector("button[type="button"]");
            
            // Store book ID for update
            form.dataset.editId = bookId;
            
            // Change button text
            submitBtn.textContent = "Update Book";
            submitBtn.onclick = function(e) {
                e.preventDefault();
                updateBook(bookId);
            };
            
            // Show add book section
            showSection("addBook");
            
            // Scroll to form
            document.getElementById("addBookSection").scrollIntoView();
            
        } catch (error) {
            alert("Error loading book: " + error.message);
        }
    }
    
    // Update book
    async function updateBook(bookId) {
        const bookData = {
            title: document.getElementById("bookTitle").value,
            author: document.getElementById("bookAuthor").value,
            isbn: document.getElementById("bookISBN").value || null,
            category: document.getElementById("bookCategory").value,
            copies: parseInt(document.getElementById("bookCopies").value),
            description: document.getElementById("bookDescription").value || ""
        };
        
        if (!bookData.title || !bookData.author || !bookData.copies) {
            alert("Please fill in all required fields (Title, Author, Copies)");
            return;
        }
        
        try {
            const response = await apiCall(`/api/books/${bookId}`, "PUT", bookData);
            alert("Book updated successfully!");
            resetBookForm();
            loadAllBooks();
            loadDashboardStats();
            showSection("manageBooks");
        } catch (error) {
            alert("Error updating book: " + error.message);
        }
    }
    
    // Reset book form to add mode
    function resetBookForm() {
        const form = document.getElementById("addBookForm");
        const submitBtn = form.querySelector("button[type="submit"]");
        
        form.reset();
        delete form.dataset.editId;
        submitBtn.textContent = "Add Book to Library";
        submitBtn.onclick = function(e) {
            e.preventDefault();
            addBook();
        };
    }
    
    // Update clearBookForm to use resetBookForm
    function clearBookForm() {
        resetBookForm();
    }            loadDashboardStats();
        } catch (error) {
            alert('Error deleting book: ' + error.message);
        }
    }
    
    // Load all users
    async function loadAllUsers() {
        try {
            const users = await loadUsers();
            displayUsersList(users);
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('usersList').innerHTML = '<p>Error loading users</p>';
        }
    }
    
    // Display users list
    function displayUsersList(users) {
        const container = document.getElementById('usersList');
        
        if (!users || users.length === 0) {
            container.innerHTML = '<p>No users found</p>';
            return;
        }
        
        let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
        html += `
            <tr style="background: #f5f5f5;">
                <th style="padding: 10px; text-align: left;">ID</th>
                <th style="padding: 10px; text-align: left;">Email</th>
                <th style="padding: 10px; text-align: left;">Name</th>
                <th style="padding: 10px; text-align: left;">Role</th>
                <th style="padding: 10px; text-align: left;">Actions</th>
            </tr>
        `;
        
        users.forEach(user => {
            html += `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;">${user.id}</td>
                    <td style="padding: 10px;">${user.email}</td>
                    <td style="padding: 10px;">${user.name || '-'}</td>
                    <td style="padding: 10px;">
                        <span style="background: ${user.role === 'admin' ? '#435f4a' : '#6c757d'}; 
                              color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                            ${user.role}
                        </span>
                    </td>
                    <td style="padding: 10px;">
                        <button class="action-btn edit-btn" onclick="editUser(${user.id})">Edit</button>
                        ${user.role !== 'admin' ? `<button class="action-btn delete-btn" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                    </td>
                </tr>
            `;
        });
        
        html += '</table></div>';
        container.innerHTML = html;
    }
    
    // Edit user (placeholder)
    function editUser(userId) {
        alert('Edit user feature coming soon! User ID: ' + userId);
    }
    
    // Delete user (placeholder)
    function deleteUser(userId) {
        alert('Delete user feature coming soon! User ID: ' + userId);
    }
    
    // Helper function to load users (placeholder - needs backend endpoint)
    async function loadUsers() {
        // This would call a backend endpoint like /api/users
        // For now, return dummy data
        return [
            { id: 1, email: 'admin@library.com', name: 'Admin User', role: 'admin' },
            { id: 2, email: 'test@student.com', name: 'Test Student', role: 'student' }
        ];
    }
    
    // Make functions available globally
    window.checkAdminAccess = checkAdminAccess;
    window.showSection = showSection;
    window.loadAllBooks = loadAllBooks;
    window.searchBooks = searchBooks;
    window.addBook = addBook;
    window.clearBookForm = clearBookForm;
    window.editBook = editBook;
    window.deleteBook = deleteBook;
    window.loadAllUsers = loadAllUsers;
    window.editUser = editUser;
    window.deleteUser = deleteUser;
    window.loadDashboardStats = loadDashboardStats;
    </script>
</body>
</html>
